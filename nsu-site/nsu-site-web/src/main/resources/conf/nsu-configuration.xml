<?xml version="1.0" encoding="utf-8" ?>

<configuration>
    <app-name>Ncms</app-name>
    <environment>${ncms.environment}</environment>
    <db-environment>${nsu.db.environment}</db-environment>

    <server-name>127.0.0.1</server-name>
    <server-port>8080</server-port>
    <site-root preferRequestUrl="true">http://${server-name}:${server-port}</site-root>

    <help>
        <site alias="help"/>
        <wiki alias="wiki"/>
    </help>

    <!--<logout-redirect>http://${server-name}:${server-port}</logout-redirect>-->
    <!--<tmpdir>used java.io.tmpdir by default</tmpdir>-->
    <ncms-prefix>/</ncms-prefix>

    <asm>
        <site-files-root resolveRelativePaths="true">/site</site-files-root>
        <exclude>/rs,/rjs,/ncms/rs,/ncms/rjs</exclude>
    </asm>

    <messages>
        <bundle>com.softmotions.ncms.Messages</bundle>
    </messages>

    <logging ref="nsu-logging.xml"/>

    <jar-web-resources>
        <resource>
            <path-prefix>/adm</path-prefix>
            <options>/nsu-site-qx/nsu\,watch=true</options>
        </resource>
    </jar-web-resources>

    <cache-headers-groups>
        <cache-group patterns="*.css,*.js">
            <expiration>7200</expiration>
        </cache-group>
        <cache-group patterns="/rs/media/fileid/*,/images/*">
            <expiration>7200</expiration>
        </cache-group>
    </cache-headers-groups>

    <mybatis config="com/softmotions/ncms/db/mybatis-config.xml"
             propsFile="{home}/.nsusite.ds"
             bindDatasource="true">
        <extra-properties>
            JDBC.driver=${nsu.JDBC.driver}
        </extra-properties>
        <extra-mappers>
            <mapper resource="ru/nsu/legacy/NSULegacyRS.xml"/>
        </extra-mappers>
    </mybatis>

    <!-- propsFile="{home}/.nsusite-import.ds" -->
    <mongo defaultDB="nsu_site_production">
        connectionUrl=localhost/nsu_site_production
    </mongo>

    <solr rebuildIndex="false">
        <provider class="com.softmotions.weboot.solr.EmbeddedSolrServerProvider" name="core">
            <instance-dir>{home}/.nsusite/solr</instance-dir>
            <config>conf/nsu-solr-config.xml</config>
            <core-config>conf/nsu-solr-core-config.xml</core-config>
            <core-schema>conf/nsu-solr-core-schema.xml</core-schema>
        </provider>
        <!--<provider class="com.softmotions.weboot.solr.HttpSolrServerProvider">-->
        <!--<connectionUrl>http://localhost:8983/solr/</connectionUrl>-->
        <!--</provider>-->
        <data-handlers>
            <data-handler class="com.softmotions.ncms.asm.PageSolrDataHandler">
                <general-fields-boost>1.0</general-fields-boost>
                <dynamic-fields-boost>0.3</dynamic-fields-boost>
                <annotation-length>300</annotation-length>
                <annotation-candidates>asm_attr_s_annotation,asm_attr_s_content,asm_attr_s_description
                </annotation-candidates>
            </data-handler>
        </data-handlers>
    </solr>

    <liquibase changelog="com/softmotions/ncms/db/changelog/db-changelog-master.xml">
        <!-- <dropAll/>-->
        <update/>
    </liquibase>

    <!-- basedir replacements: {webapp}|{cwd}|{home}|{tmp}|{newtmp} -->
    <media basedir="{home}/.nsusite/media">
        <max-upload-size>31457280</max-upload-size>
        <max-upload-inmemory-size>1048576</max-upload-inmemory-size>
        <locks-lrucache-size>128</locks-lrucache-size>
        <meta-lrucache-size>1024</meta-lrucache-size>
        <thumbnails-width>250</thumbnails-width>
        <resize-default-format>jpeg</resize-default-format>
        <max-edit-text-size>524288</max-edit-text-size>
        <system-directories>
            <directory>/site</directory>
            <directory>/pages</directory>
        </system-directories>
        <import directory="{webapp}"
                target="site"
                watch="true"
                overwrite="false"
                system="true">
            <includes>
                <include>**/*</include>
            </includes>
            <excludes>
                <exclude>META-INF/**</exclude>
                <exclude>WEB-INF/**</exclude>
                <exclude>scss*/**</exclude>
            </excludes>
        </import>
    </media>

    <httl extensions="*,httl,html">
        loggers=httl.spi.loggers.Slf4jLogger
        loaders=com.softmotions.ncms.asm.render.httl.HttlLoaderAdapter
        import.methods+=com.softmotions.ncms.mhttl.HttlAsmMethods\,com.softmotions.ncms.mhttl.HttlUtilsMethods\,ru.nsu.HttlMethods
        import.packages+=com.softmotions.ncms.mhttl\,com.softmotions.ncms.asm\,com.softmotions.commons.cont\,org.apache.commons.configuration\,org.apache.solr.common
        date.format=MM.dd.yyyy HH:mm
        time.zone=+7
        reloadable=true
        ##code.directory=/tmp/httl-code
    </httl>

    <asm>
        <resource-loaders>
            <loader class="com.softmotions.ncms.asm.render.ldrs.AsmMediaServiceResourceLoader"/>
        </resource-loaders>
    </asm>

    <security dbJndiName="java:comp/env/WSUserDatabase">
        <web-fakeuser>admin</web-fakeuser>
        <!--  для использования с WSUsersMongoDB -->
        <!--<web-fakeuser>adamansky@gmail.com</web-fakeuser>-->
        <web-access-control-allow>*</web-access-control-allow>
        <acl-lru-cache-size>4096</acl-lru-cache-size>
    </security>

    <events>
        <num-workers>1</num-workers>
    </events>

    <modules>
        <module class="com.softmotions.weboot.scheduler.SchedulerModule"/>
        <module class="com.softmotions.weboot.mb.WBMyBatisModule"/>
        <module class="com.softmotions.weboot.liquibase.WBLiquibaseModule"/>
        <module class="com.softmotions.weboot.mongo.WBMongoModule"/>
        <module class="com.softmotions.weboot.solr.WBSolrModule"/>
        <module class="com.softmotions.ncms.events.EventsModule"/>
        <module class="com.softmotions.ncms.security.NcmsSecurityModule"/>
        <module class="com.softmotions.ncms.asm.AsmModule"/>
        <module class="com.softmotions.ncms.asm.render.httl.AsmTemplateEngineHttlModule"/>
        <module class="com.softmotions.ncms.adm.AdmModule"/>
        <module class="com.softmotions.ncms.media.MediaModule"/>
        <module class="com.softmotions.ncms.mediawiki.MediaWikiModule"/>
        <module class="com.softmotions.ncms.user.UserModule"/>
        <module class="com.softmotions.ncms.rds.RefDataStoreModule"/>
        <module class="com.softmotions.ncms.qa.QAModule"/>
        <module class="ru.nsu.NSUModule"/>
        <module class="ru.nsu.pagepdf.HtmlToPdfModule"/>
        <module class="ru.nsu.legacy.NSULegacyModule"/>
    </modules>

    <ui>
        <navigation-selectors>
            <widget qxClass="ncms.pgs.PagesNav" roles="user"/>
            <widget qxClass="ncms.news.NewsNav" roles="user"/>
            <widget qxClass="ncms.mmgr.MediaNav" roles="user"/>
            <widget qxClass="ncms.asm.AsmNav" roles="admin.asm"/>
            <widget qxClass="ncms.usr.UsersNav" roles="admin.users"/>
        </navigation-selectors>
    </ui>

    <mediawiki>
        <image-base-url>/rs/mw/res/${image}</image-base-url>
        <link-base-url>/rs/mw/link/${title}</link-base-url>
        <max-inline-image-width-px>900</max-inline-image-width-px>
        <tags>
            <tag name="note" class="com.softmotions.ncms.mediawiki.NoteTag"/>
            <tag name="gmap" class="com.softmotions.ncms.mediawiki.GMapTag"/>
            <tag name="youtube" class="com.softmotions.ncms.mediawiki.YoutubeTag"/>
            <tag name="tree" class="com.softmotions.ncms.mediawiki.TreeTag"/>
        </tags>
        <interwiki-links>
            <!--<link key="page" value="/asm/${title}"/>-->
        </interwiki-links>
    </mediawiki>

    <pages>
        <default-page-language>ru</default-page-language>
        <lru-cache-size>4096</lru-cache-size>
        <lru-aliases-cache-size>16384</lru-aliases-cache-size>
    </pages>

    <oauth2>
        <provider>
            <auth-endpoint>https://my.nsu.ru/oauth2/authorize</auth-endpoint>
            <token-endpoint>https://my.nsu.ru/oauth2/token</token-endpoint>
            <api-endpoint>https://my.nsu.ru/oauth2api/userinfo</api-endpoint>
        </provider>
        <client>
            <id>540611e9498e629ba5a9e766</id>
            <secret>SQ5lPyUrzkmKypfKZl0wnhYSGtyv7GlX</secret>
        </client>
    </oauth2>

    <instagram>
        <user-ref>http://instagram.com/ignsu</user-ref>
        <user-id>589054046</user-id>
        <client-id>c8f18d693f034a55bd22d7005d4da27c</client-id>
        <cache>
            <key>_nsu_instagram</key>
            <timeout>3600000</timeout>
        </cache>
    </instagram>

    <content>
        <mainpage>
            <news>
                <a templates="index_news,index_interview,index_reportage" title="Новости" max="5"/>
                <a templates="index_interview" type="interview" title="Интервью" max="12"/>
                <a templates="index_reportage" type="reportage" title="Репортаж" max="12"/>
                <b templates="index_announce" max="5"/>
                <c templates="faculty_news" max="5"/>
            </news>
        </mainpage>
        <newsmain>
            <news>
                <type templates="index_news,index_interview,index_reportage,faculty_news,dept_news,index_orders,index_announce,faculty_announce"
                      title="Все"/>
                <type templates="faculty_news" type="faculty" title="Новости факультетов"/>
                <type templates="index_interview" type="interview" title="Интервью"/>
                <type templates="index_reportage" type="reportage" title="Репортажи"/>
                <type templates="index_announce,faculty_announce" type="announce" title="Анонсы"/>
                <type templates="index_orders" type="orders" title="Приказы и документы"/>
            </news>
        </newsmain>
        <!-- Архив и API для журналов(Пресса) -->
        <journals>
            <uzh/>
        </journals>
    </content>

    <html-to-pdf>
        <exec-path>/usr/local/bin/wkhtmltopdf</exec-path>
        <exec-extra-params>
            --print-media-type
        </exec-extra-params>
        <page-url-template>${site-root}/{id}</page-url-template>
        <asm-templates>
            journal,content,dept,faculty,index_news,index_interview,index_reportage,faculty_news,dept_news,index_orders,index_announce,faculty_announce
        </asm-templates>
    </html-to-pdf>

    <qa>
        <pages>
            <batch-size>2</batch-size>
            <batch-pause-seconds>10</batch-pause-seconds>
        </pages>
    </qa>

    <events-remember>
        <cron-spec>0 9 * * *</cron-spec>
        <notification-days-before>3</notification-days-before>
        <!-- email notificator: if dryRun is true - send mail, otherwise - write to log-->
        <notificator class="ru.nsu.events.EmailNotificator" dryRun="false">
            <mail-server-config>
                mail.smtp.host=mx.nsu.ru
                mail.transport.protocol=smtp
            </mail-server-config>
            <!--
                for templates:
                    {date} replaced to event date with format "dd.MM.yyyy HH:mm"
                    {name} replaced to event name
            -->
            <notification>
                <from>NSU &lt;noreply@nsu.ru&gt;</from>
                <content-type>text/plain;charset=UTF-8</content-type>
                <subject>{name}</subject>
                <message><![CDATA[НГУ: {date} состоится {name}]]></message>
            </notification>
        </notificator>
        <notificator class="ru.nsu.events.SMSNotificator">
            <phone-pattern><![CDATA[^(\+?7|8)\d{10}$]]></phone-pattern>
            <sms-server-api-url>https://500sms.ru/api.php</sms-server-api-url>
            <sender-props>{home}/.500-sms.ds</sender-props>
            <notification>
                <message><![CDATA[НГУ: {date} состоится {name}]]></message>
            </notification>
        </notificator>
    </events-remember>


    <nsu>
        <import-news>
            <!--<branch root="http://www.nsu.ru/exp/p0bfdf54de4235e6296000000"
                    attach="5"
                    template="index_news"/>-->
            <!--<branch root="http://www.nsu.ru/exp/ff" attach="901" template="faculty_news"/>
            <branch root="http://nsu.ru/exp/medf" attach="1187" template="faculty_news"/>
            <branch root="http://www.nsu.ru/exp/ef" attach="2263" template="faculty_news"/>
            <branch root="http://www.nsu.ru/exp/ggf" attach="1124" template="faculty_news"/>
            <branch root="http://www.nsu.ru/exp/fiya" attach="1188" template="faculty_news"/>
            <branch root="http://www.nsu.ru/exp/yurf" attach="1186" template="faculty_news"/>
            <branch root="http://www.nsu.ru/exp/filf" attach="1125" template="faculty_news"/>-->

            <!--<branch root="http://www.nsu.ru/exp/mmf/kafedra_diskretnoi_matematiki_i_informatiki" attach="3321" template="dept_news"/>
            <branch root="http://www.nsu.ru/exp/life/sport" attach="1093" template="dept_news"/>
            <branch root="http://www.nsu.ru/exp/p52425b5850afe7d11045049d" attach="1194" template="dept_news"/>
            <branch root="http://www.nsu.ru/exp/ef/kafedra_ef_obschei_sociologii" attach="2368" template="dept_news"/>
            <branch root="http://www.nsu.ru/exp/university/oms" attach="1089" template="dept_news"/>-->
        </import-news>
    </nsu>


    <social>
        <!--<vk app-id="37080997"/>--> <!-- for real nsu.ru -->
        <vk app-id="4596711" user-ref="http://vk.com/nsu24"/>
        <twitter user-ref="https://twitter.com/NskUniversity">
            <config-properties>
                <!--oauth.consumerKey=-->
                <!--oauth.consumerSecret=-->
                <!--oauth.accessToken=-->
                <!--oauth.accessTokenSecret=-->
            </config-properties>
            <tweet-attribute>tweet</tweet-attribute>
            <annotation-attribute>annotation</annotation-attribute>
        </twitter>
        <!-- TODO: replace app id by real id!    -->
        <facebook app-id="913933761970156" user-ref="https://www.facebook.com/NovosibirskUniversity"/>
        <google user-ref=""/>
        <add-this app-id="ra-5444c91965bd1f82"/>
    </social>

</configuration>
