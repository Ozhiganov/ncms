<?xml version="1.0" encoding="utf-8" ?>

<configuration>
    <app-name>Ncms</app-name>
    <help-site>http://nsu.ru</help-site>
    <logout-redirect>http://nsu.ru</logout-redirect>
    <!--<tmpdir>used java.io.tmpdir by default</tmpdir>-->
    <site-root resolveRelativePaths="true">/site</site-root>
    <ncms-prefix>/ncms</ncms-prefix>

    <jar-web-resources>
        <resource>
            <path-prefix>/</path-prefix>
            <options>/nsu-site-qx/nsu\,watch=true</options>
        </resource>
    </jar-web-resources>

    <mybatis config="com/softmotions/ncms/db/mybatis-config.xml"
             bindDatasource="true">
        JDBC.driver=${nsu.JDBC.driver}
        JDBC.url=${nsu.JDBC.url}
        JDBC.username=${nsu.JDBC.username}
        JDBC.password=${nsu.JDBC.password}
    </mybatis>

    <liquibase changelog="com/softmotions/ncms/db/changelog/db-changelog-master.xml">
        <!-- <dropAll/>-->
        <update/>
    </liquibase>

    <!-- basedir replacements: {webapp}|{cwd}|{home}|{tmp}|{newtmp} -->
    <media basedir="{home}/.nsusite/media">
        <max-upload-size>31457280</max-upload-size>
        <max-upload-inmemory-size>1048576</max-upload-inmemory-size>
        <locks-lrucache-size>128</locks-lrucache-size>
        <meta-lrucache-size>1024</meta-lrucache-size>
        <thumbnails-width>250</thumbnails-width>
        <resize-default-format>jpeg</resize-default-format>
        <max-edit-text-size>524288</max-edit-text-size>
        <system-directories>
            <directory>/site</directory>
            <directory>/pages</directory>
        </system-directories>
        <import directory="${basedir}/src/main/webapp"
                target="site"
                watch="true"
                overwrite="false"
                system="true">
            <includes>
                <include>**/*</include>
            </includes>
            <excludes>
                <exclude>META-INF/**</exclude>
                <exclude>WEB-INF/**</exclude>
                <exclude>scss*/**</exclude>
            </excludes>
        </import>
    </media>

    <httl extensions="*,httl,html">
        loggers=httl.spi.loggers.Slf4jLogger
        loaders=com.softmotions.ncms.asm.render.httl.HttlLoaderAdapter
        import.methods+=com.softmotions.ncms.asm.render.httl.HttlAsmMethods
        import.packages+=com.softmotions.ncms.mhttl
        reloadable=true
        ##code.directory=/tmp/httl-code
    </httl>

    <asm>
        <resource-loaders>
            <loader class="com.softmotions.ncms.asm.render.ldrs.AsmMediaServiceResourceLoader"/>
        </resource-loaders>
    </asm>

    <security dbJndiName="java:comp/env/WSUserDatabase">
        <web-fakeuser>admin</web-fakeuser>
        <web-access-control-allow>*</web-access-control-allow>
        <acl-lru-cache-size>4096</acl-lru-cache-size>
    </security>

    <events>
        <num-workers>1</num-workers>
    </events>

    <modules>
        <module class="com.softmotions.ncms.events.EventsModule"/>
        <module class="com.softmotions.ncms.security.NcmsSecurityModule"/>
        <module class="com.softmotions.ncms.asm.AsmModule"/>
        <module class="com.softmotions.ncms.asm.render.httl.AsmTemplateEngineHttlModule"/>
        <module class="com.softmotions.ncms.adm.AdmModule"/>
        <module class="com.softmotions.ncms.media.MediaModule"/>
        <module class="com.softmotions.ncms.mediawiki.MediaWikiModule"/>
        <module class="com.softmotions.ncms.user.UserModule"/>
    </modules>

    <ui>
        <navigation-selectors>
            <widget qxClass="ncms.pgs.PagesNav" roles="user"/>
            <widget qxClass="ncms.news.NewsNav" roles="user"/>
            <widget qxClass="ncms.mmgr.MediaNav" roles="user"/>
            <widget qxClass="ncms.asm.AsmNav" roles="admin.asm"/>
            <widget qxClass="ncms.usr.UsersNav" roles="admin.users"/>
        </navigation-selectors>
    </ui>

    <mediawiki>
        <image-base-url>${ncms-prefix}/rs/mw/res/${image}</image-base-url>
        <link-base-url>${ncms-prefix}/rs/mw/link/${title}</link-base-url>
        <max-inline-image-width-px>900</max-inline-image-width-px>
        <tags>
            <tag name="note" class="com.softmotions.ncms.mediawiki.NoteTag"/>
            <tag name="gmap" class="com.softmotions.ncms.mediawiki.GMapTag"/>
            <tag name="youtube" class="com.softmotions.ncms.mediawiki.YoutubeTag"/>
            <tag name="tree" class="com.softmotions.ncms.mediawiki.TreeTag"/>
        </tags>
        <interwiki-links>
            <!--<link key="page" value="/asm/${title}"/>-->
        </interwiki-links>
    </mediawiki>

    <pages>
        <lru-cache-size>4096</lru-cache-size>
    </pages>

</configuration>