<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="ru.nsu.hotfixes">

    <update id="NavCachedPathFixes:prepare">
       UPDATE ASMS
        SET nav_cached_path = NULL
    </update>

    <update id="NavCachedPathFixes:updateRoot">
        UPDATE ASMS AS a
        SET a.nav_cached_path = '/'
        WHERE a.nav_parent_id IS NULL
    </update>

    <update id="NavCachedPathFixes:updateChildren">
        UPDATE ASMS AS a
        SET a.nav_cached_path = (SELECT p.nav_cached_path FROM ASMS AS p where p.id = a.nav_parent_id) || a.nav_parent_id || '/'
        WHERE id IN (SELECT a2.id FROM ASMS AS a2 INNER JOIN ASMS AS p2 ON a2.nav_parent_id = p2.id WHERE a2.nav_cached_path IS NULL AND p2.nav_cached_path IS NOT NULL)
    </update>

</mapper>