<?xml version="1.0" encoding="UTF-8"?>

<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
         http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-3.1.xsd">

    <!-- ==================================================================== -->
    <!-- ====================== ASSEMBLY TABLES ============================= -->
    <!-- ==================================================================== -->

    <changeSet id="1" author="adamansky@gmail.com">

        <!-- ===================== ASM CORE ========================== -->

        <createTable tableName="ASM_CORES">
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true"/>
            </column>
            <column name="LOCATION" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="TEMPLATE_ENGINE" type="VARCHAR(255)">
            </column>
        </createTable>

        <createIndex tableName="ASM_CORES"
                     indexName="IDX_ASMCORES_LOCATION"
                     unique="true">
            <column name="LOCATION"></column>
        </createIndex>

        <createIndex tableName="ASM_CORES"
                     indexName="IDX_ASMCORES_NAME"
                     unique="false">
            <column name="NAME"></column>
        </createIndex>

        <!-- ===================== ASMS ========================== -->

        <createTable tableName="ASMS"
                     remarks="Assemblies">
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ASM_CORE_ID" type="BIGINT">
            </column>
            <column name="NAME" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(64)">
            </column>
            <column name="OPTIONS" type="VARCHAR(512)"/>
            <column name="DESCRIPTION" type="VARCHAR(255)"/>
        </createTable>

        <createIndex tableName="ASMS"
                     indexName="IDX_ASMS_NAME"
                     unique="true">
            <column name="NAME"></column>
        </createIndex>

        <createIndex tableName="ASMS"
                     indexName="IDX_ASMS_TYPENAME">
            <column name="TYPE"></column>
            <column name="NAME"></column>
        </createIndex>

        <addForeignKeyConstraint baseTableName="ASMS"
                                 baseColumnNames="ASM_CORE_ID"
                                 constraintName="FK_ASMS_ASMCORES"
                                 referencedTableName="ASM_CORES"
                                 referencedColumnNames="ID"
                                 onDelete="SET NULL"/>

        <!-- ==================== ASM_ATTRS ======================= -->

        <createTable tableName="ASM_ATTRS"
                     remarks="Assembly attributes">
            <column name="ASM_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="TYPE" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="OPTIONS" type="VARCHAR(512)"/>
            <column name="VALUE" type="VARCHAR(1024)"/>
            <column name="LARGE_VALUE" type="CLOB"/>
        </createTable>

        <createIndex tableName="ASM_ATTRS"
                     indexName="IDX_ASMATTRS_UNIQ"
                     unique="true">
            <column name="NAME"></column>
            <column name="ASM_ID"></column>
        </createIndex>

        <!-- FK ASM_ATTRS => ASM  -->
        <addForeignKeyConstraint baseTableName="ASM_ATTRS"
                                 baseColumnNames="ASM_ID"
                                 constraintName="FK_ASMATTRS_ASM"
                                 referencedTableName="ASMS"
                                 referencedColumnNames="ID"
                                 onDelete="CASCADE"/>

        <!-- ================ ASSEMBLY PARENTS ==================== -->

        <createTable tableName="ASM_PARENTS">
            <column name="ASM_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="ASM_PARENT_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="ASM_PARENTS"
                     indexName="IDX_ASMPARENTS_UNIQ"
                     unique="true">
            <column name="ASM_ID"></column>
            <column name="ASM_PARENT_ID"></column>
        </createIndex>

        <addForeignKeyConstraint baseTableName="ASM_PARENTS"
                                 baseColumnNames="ASM_ID"
                                 constraintName="FK_ASMPARENTS_ASMID"
                                 referencedTableName="ASMS"
                                 referencedColumnNames="ID"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="ASM_PARENTS"
                                 baseColumnNames="ASM_PARENT_ID"
                                 constraintName="FK_ASMPARENTS_ASMPARENTID"
                                 referencedTableName="ASMS"
                                 referencedColumnNames="ID"
                                 onDelete="CASCADE"/>


    </changeSet>

    <!-- ==================================================================== -->
    <!-- ====================== MEDIA TABLES ================================ -->
    <!-- ==================================================================== -->

    <changeSet id="2" author="adamansky@gmail.com">

        <!-- ================ MEDIA_ENTITY ==================== -->

        <createTable tableName="MEDIA_ENTITY">
            <column name="ID" type="BIGINT" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="NAME" type="VARCHAR(128)">
                <constraints nullable="false"/>
            </column>
            <column name="CONTAINER" type="INT">
                <constraints nullable="false"/>
            </column>
            <column name="FOLDER" type="VARCHAR(255)">
                <constraints nullable="false"/>
            </column>
            <column name="CONTENT_TYPE" type="VARCHAR(64)">
                <constraints nullable="false"/>
            </column>
            <column name="PUT_CONTENT_TYPE" type="VARCHAR(64)">
                <constraints nullable="true"/>
            </column>
            <column name="CONTENT_LENGTH" type="INT">
                <constraints nullable="true"/>
            </column>
            <column name="DESCRIPTION" type="VARCHAR(255)">
            </column>
            <column name="PRIMARY_ACL_ID" type="BIGINT">
            </column>
            <column name="PRIVATE_ACL" type="VARCHAR(512)">
            </column>
        </createTable>

        <createIndex tableName="MEDIA_ENTITY"
                     indexName="IDX_MEDIAENTITY_NAME">
            <column name="NAME"/>
        </createIndex>
        <createIndex tableName="MEDIA_ENTITY"
                     indexName="IDX_MEDIAENTITY_FOLDER">
            <column name="FOLDER"/>
        </createIndex>
        <createIndex tableName="MEDIA_ENTITY"
                     indexName="IDX_MEDIAENTITY_PATH"
                     unique="true">
            <column name="FOLDER"/>
            <column name="NAME"/>
        </createIndex>

        <!-- ================ MEDIA_ENTITY_TAGS ==================== -->

        <createTable tableName="MEDIA_ENTITY_TAGS">
            <column name="MEDIA_ENTITY_ID" type="BIGINT">
                <constraints nullable="false"/>
            </column>
            <column name="TAG_NAME" type="VARCHAR(32)">
                <constraints nullable="false"/>
            </column>
        </createTable>

        <createIndex tableName="MEDIA_ENTITY_TAGS"
                     indexName="IDX_MEDIAENTITYTAGS_UNIQ"
                     unique="true">
            <column name="TAG_NAME"/>
            <column name="MEDIA_ENTITY_ID"/>
        </createIndex>

        <!-- ================ MEDIA_ENTITY_ACL ==================== -->

        <createTable tableName="MEDIA_ENTITY_ACL">
            <column name="OWNER" type="BIGINT">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="ACL" type="VARCHAR(512)">
            </column>
        </createTable>


        <!-- ==================== FK ============================= -->

        <addForeignKeyConstraint baseTableName="MEDIA_ENTITY_TAGS"
                                 baseColumnNames="MEDIA_ENTITY_ID"
                                 constraintName="FK_MEDIAENTITYTAGS_ME"
                                 referencedTableName="MEDIA_ENTITY"
                                 referencedColumnNames="ID"
                                 onDelete="CASCADE"/>

        <addForeignKeyConstraint baseTableName="MEDIA_ENTITY"
                                 baseColumnNames="PRIMARY_ACL_ID"
                                 constraintName="FK_MEDIAENTITY_PRIMARYACL"
                                 referencedTableName="MEDIA_ENTITY_ACL"
                                 referencedColumnNames="OWNER"
                                 onDelete="SET NULL"/>

    </changeSet>

</databaseChangeLog>